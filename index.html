<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mock Chat App</title>

  <!-- jsPDF for client-side export (optional) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* Fonts */
    body, input, button, select, textarea {
      font-family: "Calibri", "Verdana", Arial, sans-serif;
      font-size: 14px;
      color: #0e1724;
      -webkit-font-smoothing:antialiased;
    }

    /* Layout */
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; background: linear-gradient(180deg,#eef5fb,#fbfdff); }
    .app { display:flex; gap:18px; max-width:1200px; margin:20px auto; padding:16px; align-items:stretch; }

    /* Left pane */
    .leftpane {
      width:340px;
      background:#f3f6f8; /* light gray sidebar */
      border-radius:10px;
      padding:18px;
      box-shadow: 0 8px 30px rgba(10,30,70,0.06);
      display:flex; flex-direction:column; gap:12px;
    }
    .app-title { font-weight:700; color:#0b66d0; font-size:18px; margin-bottom:4px; }
    .conn-status { color:#445; font-size:13px; }

    .tabs { display:flex; gap:8px; margin-top:8px; }
    .tab { flex:1; padding:8px; border-radius:8px; border:none; background:#fff; cursor:pointer; font-weight:600; }
    .tab.active { background:#0b66d0; color:white; }

    label { display:block; margin-top:8px; font-weight:600; color:#23314a; }
    input[type=text], select { width:100%; padding:9px 10px; border-radius:8px; border:1px solid #dfeaf6; background:#fff; margin-top:6px; }

    .primary { background:#0b66d0; color:#fff; border:none; padding:10px 12px; border-radius:8px; cursor:pointer; }
    .secondary { background:#fff; border:1px solid #e6eef8; padding:8px 10px; border-radius:8px; cursor:pointer; }

    .muted { color:#3a7; margin-top:8px; font-size:13px; }
    .error { color:#d9534f; margin-top:8px; font-size:13px; }

    /* Main pane */
    .mainpane { flex:1; display:flex; flex-direction:column; gap:12px; }
    .chat-header-main { display:flex; justify-content:space-between; align-items:center; }
    .chatTitle { font-weight:700; color:#0b2b4a; font-size:16px; }
    #duration { color:#6b7280; font-size:13px; }

    .chatArea {
      background:#ffffff;
      border-radius:10px;
      padding:16px;
      box-shadow: 0 8px 30px rgba(10,30,70,0.04);
      display:flex; flex-direction:column; gap:12px; min-height:520px;
    }
    .messages { flex:1; overflow:auto; padding:12px; border-radius:8px; background:linear-gradient(180deg,#fcfeff,#f7fbff); border:1px solid rgba(11,102,208,0.03); }

    /* message bubbles */
    .message { display:block; max-width:72%; padding:10px 12px; margin-bottom:10px; border-radius:12px; box-shadow:0 4px 12px rgba(10,30,60,0.04); clear:both; }
    .message .meta { font-size:12px; color:#6b7280; margin-bottom:6px; }
    .message.trainer { background:#0b66d0; color:white; float:left; border-bottom-left-radius:4px; }
    .message.associate { background:#f1f5f9; color:#0b1220; float:right; border-bottom-right-radius:4px; }

    .system-message { text-align:center; padding:10px; background:#fff5f5; border-radius:8px; color:#d9534f; border:1px solid rgba(217,83,79,0.08); }

    .typingIndicator { color:#6b7280; min-height:18px; font-style:italic; }
    .chatInputRow { display:flex; gap:8px; align-items:center; }
    .chatInputRow input { flex:1; padding:11px; border-radius:10px; border:1px solid #e6eef8; }
    .chatActions { display:flex; gap:8px; align-items:center; margin-top:8px; }

    .footer-note { color:#6b7280; font-size:12px; margin-top:8px; }

    @media (max-width:900px) {
      .app { flex-direction:column; padding:12px; }
      .leftpane{ width:100%; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT PANE -->
    <aside class="leftpane">
      <div>
        <div class="app-title">Mock Chat App</div>
        <div id="connStatus" class="conn-status">Not connected</div>
      </div>

      <div class="tabs" style="margin-top:10px;">
        <button id="tabCreate" class="tab active">Create</button>
        <button id="tabJoin" class="tab">Join</button>
      </div>

      <!-- Create area -->
      <div id="createArea" class="panel-body">
        <label>Trainer name</label>
        <input id="trainerName" type="text" placeholder="e.g. Tom" />
        <label>Associate name</label>
        <input id="associateName" type="text" placeholder="e.g. Rob" />
        <div style="display:flex;gap:8px;margin-top:10px;">
          <button id="createBtn" class="primary">Create Conversation</button>
        </div>
        <div id="createResult" class="muted" aria-live="polite"></div>
      </div>

      <!-- Join area -->
      <div id="joinArea" class="panel-body hidden">
        <label>Conversation Key</label>
        <input id="joinConvKey" type="text" placeholder="Enter conversation key" />
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="loadNamesBtn" class="secondary">Load Names</button>
          <button id="joinBtn" class="primary">Join</button>
        </div>

        <label style="margin-top:12px">Select Participant</label>
        <select id="joinNameSelect">
          <option value="">-- Select Participant --</option>
        </select>

        <div id="joinResult" class="error" aria-live="polite"></div>
      </div>

      <div style="flex:1"></div>

      <div class="footer-note">
        <div>Frontend: GitHub Pages</div>
        <div>Backend: Google Apps Script (proxied)</div>
      </div>
    </aside>

    <!-- MAIN CHAT AREA -->
    <main class="mainpane">
      <div class="chat-header-main">
        <div id="chatHeader" class="chatTitle">Not in a conversation</div>
        <div id="duration">Duration: 00:00:00</div>
      </div>

      <section class="chatArea">
        <div id="messages" class="messages" aria-live="polite"></div>

        <div id="chatStatus" class="chatStatus"></div>
        <div id="typingIndicator" class="typingIndicator"></div>

        <div class="chatInputRow">
          <input id="messageInput" type="text" placeholder="Type your message..." autocomplete="off" />
          <button id="sendBtn" class="primary">Send</button>
        </div>

        <div class="chatActions">
          <button id="exportBtn" class="secondary" style="display:none">Export PDF</button>
          <div id="chatResult" class="muted"></div>
        </div>
      </section>
    </main>
  </div>

<script type="module">
import { createConversation, sendMessage, getMessages, getConversation } from "./api.js";

const POLLING_MS = 2000;
const $ = id => document.getElementById(id);

const tabCreate = $('tabCreate'), tabJoin = $('tabJoin');
const createArea = $('createArea'), joinArea = $('joinArea');
const trainerName = $('trainerName'), associateName = $('associateName');
const createBtn = $('createBtn'), createResult = $('createResult');
const joinConvKey = $('joinConvKey'), loadNamesBtn = $('loadNamesBtn'), joinBtn = $('joinBtn');
const joinNameSelect = $('joinNameSelect'), joinResult = $('joinResult');
const connStatus = $('connStatus');
const chatHeader = $('chatHeader'), durationEl = $('duration');
const messagesEl = $('messages'), typingIndicator = $('typingIndicator');
const messageInput = $('messageInput'), sendBtn = $('sendBtn');
const exportBtn = $('exportBtn'), chatStatus = $('chatStatus');

let currentConvKey = null, currentUserName = null, currentUserRole = null, conversationStartTime = null;
let lastMessageCount = 0, pollTimer = null, sendingInProgress = false;

// tab switching
tabCreate.addEventListener('click', () => {
  tabCreate.classList.add('active'); tabJoin.classList.remove('active');
  createArea.classList.remove('hidden'); joinArea.classList.add('hidden');
});
tabJoin.addEventListener('click', () => {
  tabJoin.classList.add('active'); tabCreate.classList.remove('active');
  joinArea.classList.remove('hidden'); createArea.classList.add('hidden');
});

// create conversation
createBtn.addEventListener('click', async () => {
  const t = trainerName.value.trim(), a = associateName.value.trim();
  if (!t || !a) return createResult.textContent = 'Please enter both names';
  createResult.textContent = 'Creating...';
  try {
    const out = await createConversation(t, a);
    if (!out.convKey) throw new Error('Failed to create conversation');
    currentConvKey = out.convKey;
    currentUserName = t;
    currentUserRole = 'trainer';
    conversationStartTime = new Date();
    chatHeader.textContent = `${t} (Trainer) | ${a}`;
    connStatus.textContent = `Key: ${out.convKey}`;
    createResult.textContent = `Created: ${out.convKey}`;
    startChat();
  } catch (e) {
    console.error(e);
    createResult.textContent = e.message;
  }
});

// join conversation
joinBtn.addEventListener('click', async () => {
  const key = joinConvKey.value.trim();
  const name = (joinNameSelect.value || '').split('|')[0];
  if (!key || !name) return joinResult.textContent = 'Enter key and name';

  try {
    const conv = await getConversation(key);
    if (!conv) return joinResult.textContent = 'Conversation not found';

    currentConvKey = key;
    currentUserName = name;
    currentUserRole = conv.trainerName === name ? 'trainer' : 'associate';
    chatHeader.textContent = `${conv.trainerName} (Trainer) | ${conv.associateName}`;
    connStatus.textContent = `Key: ${key}`;
    conversationStartTime = conv.startTime ? new Date(conv.startTime) : new Date();
    joinResult.textContent = 'Joined successfully.';
    startChat();
  } catch (err) {
    console.error(err);
    joinResult.textContent = 'Error joining conversation';
  }
});

// start chat loop
function startChat() {
  if (pollTimer) clearInterval(pollTimer);
  fetchMessages();
  pollTimer = setInterval(fetchMessages, POLLING_MS);
  exportBtn.style.display = 'inline-block';
  updateDuration();
}

// fetch messages
async function fetchMessages() {
  if (!currentConvKey) return;
  try {
    const list = await getMessages(currentConvKey);
    if (!Array.isArray(list)) return;
    renderMessages(list);
  } catch (err) {
    console.error('fetchMessages error', err);
  }
}

// render
function renderMessages(messages) {
  messagesEl.innerHTML = '';
  for (const msg of messages) {
    const div = document.createElement('div');
    div.className = 'message ' + (msg.role === 'trainer' ? 'trainer' : 'associate');
    div.innerHTML = `<div class="meta">${msg.senderName} • ${new Date(msg.timestamp).toLocaleTimeString()}</div><div>${msg.text}</div>`;
    messagesEl.appendChild(div);
  }
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// send message
sendBtn.addEventListener('click', sendMsg);
messageInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMsg(); });

async function sendMsg() {
  const txt = messageInput.value.trim();
  if (!txt || !currentConvKey) return;
  messageInput.value = '';
  try {
    await sendMessage(currentConvKey, currentUserName, currentUserRole, txt);
    await fetchMessages();
  } catch (err) {
    alert('Send failed: ' + err.message);
  }
}

// duration timer
function updateDuration() {
  if (!conversationStartTime) return;
  const diff = Date.now() - conversationStartTime.getTime();
  const hrs = Math.floor(diff / 3600000), mins = Math.floor((diff % 3600000) / 60000), secs = Math.floor((diff % 60000) / 1000);
  durationEl.textContent = `Duration: ${hrs.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
  setTimeout(updateDuration, 1000);
}

</script>

</body>
</html>


